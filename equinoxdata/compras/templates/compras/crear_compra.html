{% extends 'base.html' %}
{% load filters %}

{% block content %}
  <div class="container">
    <h2 class="mt-4">Registrar una Compra</h2>

    {% if messages %}
      <div class="alert alert-info">
        {% for message in messages %}
          <p>{{ message }}</p>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Formulario para registrar una compra -->
    <form method="POST" class="mt-3">
      {% csrf_token %}
      <div class="form-group">
        <label for="producto">Producto</label>
        <select name="producto" id="producto" class="form-control" required>
          {% for producto in productos %}
            <option value="{{ producto.id }}">{{ producto.nombre }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="cantidad">Cantidad</label>
        <input type="number" name="cantidad" id="cantidad" class="form-control" required min="1">
      </div>

      <div class="form-group">
        <label for="precio">Precio por botella</label>
        <input type="number" name="precio" id="precio" class="form-control" required step="0.01" min="0.01">
      </div>

      <button type="submit" class="btn btn-primary">Registrar Compra</button>
    </form>

    <!-- Botón para consolidar pedido -->
    <form method="POST" action="{% url 'compras:consolidar_pedido' %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-success">Consolidar Pedido del Día</button>
    </form>

    <!-- Tabla de compras registradas en el día actual -->
    <h3 class="mt-5">Compras Registradas el {{ fecha_actual }}</h3>
    <table class="table table-bordered table-striped mt-3">
      <thead class="thead-dark">
        <tr>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Precio por botella</th>
          <th>Total</th>
          <th>Registrado por</th>
          <th>acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for compra in compras_del_dia %}
          <tr>
            <td>{{ compra.producto.nombre }}</td>
            <td>{{ compra.cantidad }}</td>
            <td>{{ compra.precio }}</td>
            <td>{{ compra.cantidad|multiply:compra.precio }}</td> <!-- Total = Cantidad * Precio -->
            <td>{{ compra.personal.username }}</td>
            <td>
                <!-- Botón para eliminar compra -->
                <form method="post" action="{% url 'compras:eliminar_compra' compra.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" onclick="return confirm('¿Estás seguro de que deseas eliminar esta compra?');">Eliminar</button>
                </form>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="5" class="text-center">No se han registrado compras hoy.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}
